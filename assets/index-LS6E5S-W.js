(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const Q=1,Y=2,P=3,re=0,be=1,oe=2,Ce=window.innerWidth<=640,_=window.innerWidth>800,W=_&&window.innerHeight<300,ke=(()=>{const r=navigator.hardwareConcurrency;if(!r)return!1;const e=window.innerWidth<=1024?4:8;return r>=e})(),we=7680,Me=4320,ve=.9,E=Math.PI*2,I=Math.PI*.5,p={Red:"#ff0043",Green:"#14fc56",Blue:"#1e7fff",Purple:"#e60aff",Gold:"#ffbf36",White:"#ffffff"},H="_INVISIBLE_";function Ee(){return Ce?.9:W?.75:1}const qe={quality:P,shell:"Random",size:3,wordShell:!0,autoLaunch:!0,finale:!0,skyLighting:oe,longExposure:!1,scaleFactor:Ee(),hideControls:!1},K={...qe,paused:!0,soundEnabled:!1,menuOpen:!1,fullscreen:!1,openHelpTopic:null};class Fe{state;listeners=new Set;constructor(){this.state={...K},W&&(this.state.hideControls=!0),_?this.state.size=3:W?this.state.size=1.2:this.state.size=2,ke?this.state.quality=P:this.state.quality=Y}getState(){return this.state}get(e){return this.state[e]}set(e,t){const s={...this.state};this.state={...this.state,[e]:t},this.notifyListeners(s),this.persist()}update(e){const t={...this.state};this.state={...this.state,...e},this.notifyListeners(t),this.persist()}reset(){const e={...this.state};this.state={...K},this.notifyListeners(e),this.persist()}STORAGE_KEY="cm_fireworks_data";load(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const{schemaVersion:t,data:s}=JSON.parse(e);t==="1.2"&&(this.update({quality:s.quality,size:s.size,skyLighting:s.skyLighting,scaleFactor:s.scaleFactor}),console.log(`Loaded config (schema version ${t})`))}else if(localStorage.getItem("schemaVersion")==="1"){const t=localStorage.getItem("configSize");if(t)try{const s=JSON.parse(t),i=parseInt(s,10);i>=0&&i<=4&&this.update({size:i})}catch(s){console.error("Error parsing legacy config:",s)}}}catch(e){console.warn("Failed to load config:",e)}}persist(){try{const e={quality:this.state.quality,size:this.state.size,skyLighting:this.state.skyLighting,scaleFactor:this.state.scaleFactor};localStorage.setItem(this.STORAGE_KEY,JSON.stringify({schemaVersion:"1.2",data:e}))}catch(e){console.warn("Failed to save config:",e)}}getComputed(){const e=this.state.quality;return{isLowQuality:e===Q,isNormalQuality:e===Y,isHighQuality:e===P,sparkDrawWidth:e===P?.75:1}}get quality(){return this.state.quality}get isLowQuality(){return this.state.quality===Q}get isNormalQuality(){return this.state.quality===Y}get isHighQuality(){return this.state.quality===P}get isRunning(){return!this.state.paused&&!this.state.menuOpen}get canPlaySound(){return this.state.soundEnabled&&!this.state.paused}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>{try{t(this.state,e)}catch(s){console.error("ConfigManager listener error:",s)}})}togglePause(e){const t=e!==void 0?e:!this.state.paused;this.set("paused",t)}toggleSound(e){const t=e!==void 0?e:!this.state.soundEnabled;this.set("soundEnabled",t)}toggleMenu(e){const t=e!==void 0?e:!this.state.menuOpen;this.set("menuOpen",t)}toggleFullscreen(e){const t=e!==void 0?e:!this.state.fullscreen;this.set("fullscreen",t)}setHelpTopic(e){this.set("openHelpTopic",e)}}const d=new Fe,xe=()=>{let r=!1,e=0;const t=[];function s(){window.requestAnimationFrame?requestAnimationFrame(i):window.webkitRequestAnimationFrame(i)}function i(a){let o=a-e;e=a,o<0?o=17:o>68&&(o=68),t.forEach(n=>n(o,o/16.6667)),s()}return{addListener(a){if(typeof a!="function")throw new Error("Ticker.addListener() requires a function reference passed for a callback.");t.push(a),r||(r=!0,s())}}},He=xe();class w{canvas;ctx;speed;dpr;width;height;naturalWidth;naturalHeight;_listeners;static stages=[];static disableHighDPI=!1;static lastTouchTimestamp=0;constructor(e){const t=typeof e=="string"?document.getElementById(e):e;if(!t)throw new Error(`Canvas element not found: ${e}`);this.canvas=t,this.ctx=t.getContext("2d"),this.canvas.style.touchAction="none",this.speed=1,this.dpr=(window.devicePixelRatio||1)/(this.ctx.backingStorePixelRatio||1),this.width=t.width,this.height=t.height,this.naturalWidth=this.width*this.dpr,this.naturalHeight=this.height*this.dpr,this.width!==this.naturalWidth&&(this.canvas.width=this.naturalWidth,this.canvas.height=this.naturalHeight,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px"),w.stages.push(this),this._listeners={resize:[],pointerstart:[],pointermove:[],pointerend:[],lastPointerPos:{x:0,y:0}}}addEventListener(e,t){try{e==="ticker"?He.addListener(t):this._listeners[e].push(t)}catch{throw new Error("Invalid Event")}}dispatchEvent(e,t){const s=this._listeners[e];if(s&&Array.isArray(s))s.forEach(i=>i.call(this,t));else throw new Error("Invalid Event")}resize(e,t){this.width=e,this.height=t,this.naturalWidth=e*this.dpr,this.naturalHeight=t*this.dpr,this.canvas.width=this.naturalWidth,this.canvas.height=this.naturalHeight,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.dispatchEvent("resize")}static windowToCanvas(e,t,s){const i=e.getBoundingClientRect();return{x:(t-i.left)*(e.width/i.width),y:(s-i.top)*(e.height/i.height)}}static mouseHandler(e){if(Date.now()-w.lastTouchTimestamp<500)return;let t="start";e.type==="mousemove"?t="move":e.type==="mouseup"&&(t="end"),w.stages.forEach(s=>{const i=w.windowToCanvas(s.canvas,e.clientX,e.clientY);s.pointerEvent(t,i.x/s.dpr,i.y/s.dpr)})}static touchHandler(e){w.lastTouchTimestamp=Date.now();let t="start";e.type==="touchmove"?t="move":e.type==="touchend"&&(t="end"),w.stages.forEach(s=>{for(const i of Array.from(e.changedTouches)){let a;t!=="end"?(a=w.windowToCanvas(s.canvas,i.clientX,i.clientY),s._listeners.lastPointerPos=a,t==="start"&&s.pointerEvent("move",a.x/s.dpr,a.y/s.dpr)):a=s._listeners.lastPointerPos,s.pointerEvent(t,a.x/s.dpr,a.y/s.dpr)}})}pointerEvent(e,t,s){const i={type:e,x:t,y:s};i.onCanvas=t>=0&&t<=this.width&&s>=0&&s<=this.height,this.dispatchEvent("pointer"+e,i)}}document.addEventListener("mousedown",w.mouseHandler);document.addEventListener("mousemove",w.mouseHandler);document.addEventListener("mouseup",w.mouseHandler);document.addEventListener("touchstart",w.touchHandler);document.addEventListener("touchmove",w.touchHandler);document.addEventListener("touchend",w.touchHandler);class G{pool=[];factory;reset;constructor(e,t=()=>{}){this.factory=e,this.reset=t}acquire(){return this.pool.length>0?this.pool.pop():this.factory()}release(e){this.reset(e),this.pool.push(e)}get size(){return this.pool.length}clear(){this.pool=[]}preallocate(e){for(let t=0;t<e;t++)this.pool.push(this.factory())}}const Te=Object.keys(p),O=Te.map(r=>p[r]),j=[...O,H],ae={};O.forEach(r=>{ae[r]={r:parseInt(r.substr(1,2),16),g:parseInt(r.substr(3,2),16),b:parseInt(r.substr(5,2),16)}});class ze{starPool;sparkPool;flashPool;activeStars={};activeSparks={};activeFlashes=[];starAirDrag=.98;starAirDragHeavy=.992;sparkAirDrag=.9;sparkDrawWidth=2;constructor(){this.starPool=new G(()=>this.createStar(),t=>this.resetStar(t)),this.sparkPool=new G(()=>this.createSpark(),t=>this.resetSpark(t)),this.flashPool=new G(()=>({x:0,y:0,radius:0}),()=>{}),j.forEach(t=>{this.activeStars[t]=[],this.activeSparks[t]=[]}),d.subscribe(()=>{const t=d.getComputed();this.sparkDrawWidth=t.sparkDrawWidth});const e=d.getComputed();this.sparkDrawWidth=e.sparkDrawWidth}createStar(){return{x:0,y:0,prevX:0,prevY:0,color:"",speedX:0,speedY:0,life:0,fullLife:0,size:3,visible:!0,heavy:!1,spinAngle:0,spinSpeed:.8,spinRadius:0,sparkFreq:0,sparkSpeed:1,sparkTimer:0,sparkColor:"",sparkLife:750,sparkLifeVariation:.25,strobe:!1}}resetStar(e){e.onDeath=void 0,e.secondColor=void 0,e.transitionTime=void 0,e.colorChanged=void 0,e.strobeFreq=void 0}addStar(e){const t=this.starPool.acquire(),{x:s,y:i,color:a,angle:o,speed:n,life:l,speedOffX:h=0,speedOffY:c=0,size:m=3}=e;return t.visible=!0,t.heavy=!1,t.x=s,t.y=i,t.prevX=s,t.prevY=i,t.color=a,t.speedX=Math.sin(o)*n+h,t.speedY=Math.cos(o)*n+c,t.life=l,t.fullLife=l,t.size=m,t.spinAngle=Math.random()*E,t.spinSpeed=.8,t.spinRadius=0,t.sparkFreq=0,t.sparkSpeed=1,t.sparkTimer=0,t.sparkColor=a,t.sparkLife=750,t.sparkLifeVariation=.25,t.strobe=!1,this.activeStars[a].push(t),t}removeStar(e){const t=this.activeStars[e.color],s=t.indexOf(e);s!==-1&&t.splice(s,1),this.starPool.release(e)}createSpark(){return{x:0,y:0,prevX:0,prevY:0,color:"",speedX:0,speedY:0,life:0}}resetSpark(e){}addSpark(e){const t=this.sparkPool.acquire(),{x:s,y:i,color:a,angle:o,speed:n,life:l}=e;return t.x=s,t.y=i,t.prevX=s,t.prevY=i,t.color=a,t.speedX=Math.sin(o)*n,t.speedY=Math.cos(o)*n,t.life=l,this.activeSparks[a].push(t),t}removeSpark(e){const t=this.activeSparks[e.color],s=t.indexOf(e);s!==-1&&t.splice(s,1),this.sparkPool.release(e)}addFlash(e,t,s){const i=this.flashPool.acquire();return i.x=e,i.y=t,i.radius=s,this.activeFlashes.push(i),i}popFlash(){const e=this.activeFlashes.pop();return e&&this.flashPool.release(e),e}update(e,t,s,i){const a=1-(1-this.starAirDrag)*t,o=1-(1-this.starAirDragHeavy)*t,n=1-(1-this.sparkAirDrag)*t,l=e/1e3*s;j.forEach(h=>{const c=this.activeStars[h];for(let S=c.length-1;S>=0;S--){const u=c[S];u.updateFrame!==i&&(u.updateFrame=i,u.life-=e,u.life<=0?(u.onDeath&&u.onDeath(u),c.splice(S,1),this.starPool.release(u)):this.updateStar(u,t,a,o,l,e))}const m=this.activeSparks[h];for(let S=m.length-1;S>=0;S--){const u=m[S];u.life-=e,u.life<=0?(m.splice(S,1),this.sparkPool.release(u)):(u.prevX=u.x,u.prevY=u.y,u.x+=u.speedX*t,u.y+=u.speedY*t,u.speedX*=n,u.speedY*=n,u.speedY+=l)}})}updateStar(e,t,s,i,a,o){const n=Math.pow(e.life/e.fullLife,.5),l=1-n;if(e.prevX=e.x,e.prevY=e.y,e.x+=e.speedX*t,e.y+=e.speedY*t,e.heavy?(e.speedX*=i,e.speedY*=i):(e.speedX*=s,e.speedY*=s),e.speedY+=a,e.spinRadius&&(e.spinAngle+=e.spinSpeed*t,e.x+=Math.sin(e.spinAngle)*e.spinRadius*t,e.y+=Math.cos(e.spinAngle)*e.spinRadius*t),e.sparkFreq)for(e.sparkTimer-=o;e.sparkTimer<0;)e.sparkTimer+=e.sparkFreq*.75+e.sparkFreq*l*4,this.addSpark({x:e.x,y:e.y,color:e.sparkColor,angle:Math.random()*E,speed:Math.random()*e.sparkSpeed*n,life:e.sparkLife*.8+Math.random()*e.sparkLifeVariation*e.sparkLife});if(e.transitionTime&&e.life<e.transitionTime){if(e.secondColor&&!e.colorChanged){e.colorChanged=!0;const h=this.activeStars[e.color],c=h.indexOf(e);c!==-1&&h.splice(c,1),e.color=e.secondColor,this.activeStars[e.secondColor].push(e),e.secondColor===H&&(e.sparkFreq=0)}e.strobe&&e.strobeFreq&&(e.visible=Math.floor(e.life/e.strobeFreq)%3===0)}}getTotalStarCount(){let e=0;return O.forEach(t=>{e+=this.activeStars[t].length}),e}getColorBrightness(){let e=0,t=0,s=0;return O.forEach(i=>{const a=ae[i],o=this.activeStars[i].length;e+=a.r*o,t+=a.g*o,s+=a.b*o}),{r:e,g:t,b:s}}}const C=new ze,J=Object.keys(p);function V(){return p[J[Math.floor(Math.random()*J.length)]]}function k(r){const e=r?.notSame,t=r?.notColor,s=r?.limitWhite;let i=V();return s&&i===p.White&&Math.random()<.88&&(i=V()),e?V():(t&&i===t&&(i=V()),i)}function U(){return Math.random()<.5?p.Gold:p.White}function R(r){const e=typeof r=="string"?r:r[0];return e===p.White||e===p.Gold?k():U()}function ne(){return d.isLowQuality}function Pe(){return d.isHighQuality}const le=(r=1)=>{const e=Math.random()<.25,t=Math.random()<.72,s=t?k({limitWhite:!0}):[k(),k({notSame:!0})],i=t&&Math.random()<.42,a=i?R(s):void 0,o=t&&(Math.random()<.2||typeof s=="string"&&s===p.White)?a||k({notColor:typeof s=="string"?s:s[0],limitWhite:!0}):void 0,n=!i&&s!==p.White&&Math.random()<.42;let l=e?1.1:1.25;return ne()&&(l*=.8),Pe()&&(l=1.2),{shellSize:r,spreadSize:300+r*100,starLife:900+r*200,starDensity:l,color:s,secondColor:o,glitter:e?"light":void 0,glitterColor:U(),pistil:i,pistilColor:a,streamers:n}},We=(r=1)=>{const e=le(r);e.starLife=(e.starLife||900)*1.5;const t=k({notColor:p.White});e.streamers=!0;const s=Math.random()<.42,i=s?R(t):void 0;return e.color=H,e.secondColor=t,e.pistil=s,e.pistilColor=i,e.glitter=void 0,e},Oe=(r=1)=>{const e=k({limitWhite:!0});return{shellSize:r,spreadSize:280+r*92,starLife:1100+r*200,starLifeVariation:.4,starDensity:1.1,color:e,glitter:"light",glitterColor:p.White,strobe:!0,strobeColor:Math.random()<.5?p.White:void 0,pistil:Math.random()<.5,pistilColor:R(e)}},Re=(r=1)=>{const e=k(),t=Math.random()<.5;return{shellSize:r,color:e,spreadSize:250+r*75,starDensity:t?.15:.4,starLife:1800+r*200,glitter:t?"thick":"heavy"}},Ie=(r=1)=>{const e=k(),t=Math.random()<.75;return{shellSize:r,ring:!0,color:e,spreadSize:300+r*100,starLife:900+r*200,starCount:2.2*E*(r+1),pistil:t,pistilColor:R(e),glitter:t?void 0:"light",glitterColor:e===p.Gold?p.Gold:p.White,streamers:Math.random()<.3}},Ae=(r=1)=>{const e=k({limitWhite:!0});return{shellSize:r,spreadSize:300+r*100,starLife:750+r*160,starLifeVariation:.4,starDensity:.85,color:e,crossette:!0,pistil:Math.random()<.5,pistilColor:R(e)}},Be=(r=1)=>{let e;return Math.random()<.65?e="random":Math.random()<.15?e=k():e=[k(),k({notSame:!0})],{shellSize:r,spreadSize:300+r*120,starDensity:.12,starLife:500+r*50,starLifeVariation:.5,color:e,floral:!0}},De=(r=1)=>({shellSize:r,color:H,spreadSize:300+r*120,starDensity:.12,starLife:500+r*50,starLifeVariation:.5,glitter:"medium",glitterColor:p.Gold,fallingLeaves:!0}),Ve=(r=1)=>({shellSize:r,spreadSize:300+r*100,starDensity:.6,starLife:3e3+r*300,glitter:"willow",glitterColor:p.Gold,color:H}),Ne=(r=1)=>{const e=Math.random()<.75?p.Gold:k();return{shellSize:r,spreadSize:380+r*75,starDensity:ne()?.65:1,starLife:600+r*100,starLifeVariation:.32,glitter:"light",glitterColor:p.Gold,color:e,crackle:!0,pistil:Math.random()<.65,pistilColor:R(e)}},Ye=(r=1)=>{const e=k();return{shellSize:r,horsetail:!0,color:e,spreadSize:250+r*38,starDensity:.9,starLife:2500+r*300,glitter:"medium",glitterColor:Math.random()<.5?U():e,strobe:e===p.White}},_e=(r=1)=>({shellSize:r,spreadSize:300+r*100,starLife:1e3+r*200,starLifeVariation:.5,starDensity:1.2,color:p.Red,glitter:"light",glitterColor:p.Gold,heart:!0}),Ge=(r=1)=>({shellSize:r,spreadSize:300+r*100,starLife:1e3+r*200,starLifeVariation:.5,starDensity:1.2,color:p.Gold,glitter:"light",glitterColor:p.White,starShape:!0});class Xe{types=new Map;typeNames=[];fastShellBlacklist=["Falling Leaves","Floral","Willow"];constructor(){this.register("Crysanthemum",le),this.register("Ghost",We),this.register("Strobe",Oe),this.register("Palm",Re),this.register("Ring",Ie),this.register("Crossette",Ae),this.register("Floral",Be),this.register("Falling Leaves",De),this.register("Willow",Ve),this.register("Crackle",Ne),this.register("Horse Tail",Ye),this.register("Heart",_e),this.register("Star",Ge)}register(e,t){this.types.set(e,t),e!=="Random"&&this.typeNames.push(e)}getFactory(e){return this.types.get(e)}createOptions(e,t){if(e==="Random")return this.createRandomOptions(t);const s=this.types.get(e);if(!s)throw new Error(`Unknown shell type: ${e}`);return s(t)}getRandomTypeName(){return Math.random()<.5?"Crysanthemum":this.typeNames[Math.floor(Math.random()*this.typeNames.length)]}createRandomOptions(e){const t=this.getRandomTypeName();return this.types.get(t)(e)}getFastFactory(){const e=d.get("shell"),t=e==="Random";let s=t?this.getRandomTypeName():e;if(t)for(;this.fastShellBlacklist.includes(s);)s=this.getRandomTypeName();return this.types.get(s)}getConfiguredOptions(e){const t=d.get("shell");return this.createOptions(t,e)}getTypeNames(){return["Random",...this.typeNames]}}const M=new Xe,x={toDeg:180/Math.PI,toRad:Math.PI/180,halfPI:Math.PI/2,twoPI:Math.PI*2,dist(r,e){return Math.sqrt(r*r+e*e)},pointDist(r,e,t,s){const i=t-r,a=s-e;return Math.sqrt(i*i+a*a)},angle(r,e){return x.halfPI+Math.atan2(e,r)},pointAngle(r,e,t,s){return x.halfPI+Math.atan2(s-e,t-r)},splitVector(r,e){return{x:Math.sin(e)*r,y:-Math.cos(e)*r}},random(r,e){return Math.random()*(e-r)+r},randomInt(r,e){return(Math.random()*(e-r+1)|0)+r},randomChoice(r,...e){if(e.length===0&&Array.isArray(r))return r[Math.random()*r.length|0];const t=Array.isArray(r)?r:[r,...e];return t[Math.random()*t.length|0]},clamp(r,e,t){return Math.min(Math.max(r,e),t)},literalLattice(r,e=3,t="Georgia",s="60px"){const i=[],a=document.createElement("canvas"),o=a.getContext("2d"),n=`${s} ${t}`;o.font=n;const l=o.measureText(r).width,h=parseInt(s.match(/(\d+)px/)?.[1]||"60");a.width=l+20,a.height=h+20,o.font=n,o.fillText(r,10,h+10);const c=o.getImageData(0,0,a.width,a.height);for(let m=0;m<c.height;m+=e)for(let S=0;S<c.width;S+=e){const u=(m*c.width+S)*4;c.data[u+3]>0&&i.push({x:S,y:m})}return{width:a.width,height:a.height,points:i}}};let A=()=>{};function $e(r){A=r}let he=()=>{},ce=()=>{},de=()=>{},ue=()=>{};function Qe(r){he=r.crossette,ce=r.floral,de=r.fallingLeaves,ue=r.crackle}let z=()=>{},fe=()=>{},ge=()=>{},pe=()=>{},me=()=>{},Se=()=>"";function Ue(r){z=r.createBurst,fe=r.createParticleArc,ge=r.createWordBurst,pe=r.createHeartBurst,me=r.createStarBurst,Se=r.randomWord}class b{shellSize;spreadSize;starCount;starLife;starLifeVariation;color;glitterColor;glitter;pistil;pistilColor;streamers;crossette;floral;crackle;fallingLeaves;horsetail;ring;strobe;strobeColor;secondColor;disableWord;heart;starShape;comet=null;stageW=0;stageH=0;constructor(e){if(this.shellSize=e.shellSize||1,this.spreadSize=e.spreadSize,this.starLife=e.starLife,this.starLifeVariation=e.starLifeVariation||.125,this.color=e.color||k(),this.glitterColor=e.glitterColor||(typeof this.color=="string"?this.color:this.color[0]),this.disableWord=e.disableWord||!1,this.glitter=e.glitter,this.pistil=e.pistil,this.pistilColor=e.pistilColor,this.streamers=e.streamers,this.crossette=e.crossette,this.floral=e.floral,this.crackle=e.crackle,this.fallingLeaves=e.fallingLeaves,this.horsetail=e.horsetail,this.ring=e.ring,this.strobe=e.strobe,this.strobeColor=e.strobeColor,this.secondColor=e.secondColor,e.starCount)this.starCount=e.starCount;else{const t=e.starDensity||1,s=this.spreadSize/54;this.starCount=Math.max(6,s*s*t)}}setStage(e,t){this.stageW=e,this.stageH=t}launch(e,t){const s=d.quality,i=d.isHighQuality,a=this.stageW,o=this.stageH,n=60,l=50,c=o-o*.45,m=e*(a-n*2)+n,S=o,u=c-t*(c-l),g=S-u,L=Math.pow(g*.04,.64),f=C.addStar({x:m,y:S,color:typeof this.color=="string"&&this.color!=="random"?this.color:p.White,angle:Math.PI,speed:L*(this.horsetail?1.2:1),life:L*(this.horsetail?100:400)});this.comet=f,f.heavy=!0,f.spinRadius=x.random(.32,.85),f.sparkFreq=32/s,i&&(f.sparkFreq=8),f.sparkLife=320,f.sparkLifeVariation=3,(this.glitter==="willow"||this.fallingLeaves)&&(f.sparkFreq=20/s,f.sparkSpeed=.5,f.sparkLife=500),this.color===H&&(f.sparkColor=p.Gold),Math.random()>.4&&!this.horsetail&&(f.secondColor=H,f.transitionTime=Math.pow(Math.random(),1.5)*700+500),f.onDeath=()=>this.burst(f.x,f.y),A("lift")}burst(e,t){const s=d.quality,i=d.isHighQuality,a=this.spreadSize/96;let o,n,l,h,c,m=.25,S=!1;this.crossette&&(n=g=>{S||(A("crackleSmall"),S=!0),he(g)}),this.crackle&&(n=g=>{S||(A("crackle"),S=!0),ue(g)}),this.floral&&(n=ce),this.fallingLeaves&&(n=de),this.glitter==="light"?(l=400,h=.3,c=300,m=2):this.glitter==="medium"?(l=200,h=.44,c=700,m=2):this.glitter==="heavy"?(l=80,h=.8,c=1400,m=2):this.glitter==="thick"?(l=16,h=i?1.65:1.5,c=1400,m=3):this.glitter==="streamer"?(l=32,h=1.05,c=620,m=2):this.glitter==="willow"&&(l=120,h=.34,c=1400,m=3.8),l&&(l=l/s);const u=(g,L)=>{const f=this.spreadSize/1800,y=C.addStar({x:e,y:t,color:o||k(),angle:g,speed:L*a,life:this.starLife+Math.random()*this.starLife*this.starLifeVariation,speedOffX:this.horsetail?this.comet?.speedX:0,speedOffY:this.horsetail?this.comet?.speedY:-f});this.secondColor&&(y.transitionTime=this.starLife*(Math.random()*.05+.32),y.secondColor=this.secondColor),this.strobe&&(y.transitionTime=this.starLife*(Math.random()*.08+.46),y.strobe=!0,y.strobeFreq=Math.random()*20+40,this.strobeColor&&(y.secondColor=this.strobeColor)),y.onDeath=n,this.glitter&&l&&(y.sparkFreq=l,y.sparkSpeed=h,y.sparkLife=c,y.sparkLifeVariation=m,y.sparkColor=this.glitterColor,y.sparkTimer=Math.random()*y.sparkFreq)};if(typeof this.color=="string")if(this.color==="random"?o=void 0:o=this.color,this.ring){const g=Math.random()*Math.PI,L=Math.pow(Math.random(),2)*.85+.15;fe(0,E,this.starCount,0,f=>{const y=Math.sin(f)*a*L,D=Math.cos(f)*a,ye=x.pointDist(0,0,y,D),Le=x.pointAngle(0,0,y,D)+g,T=C.addStar({x:e,y:t,color:o,angle:Le,speed:ye,life:this.starLife+Math.random()*this.starLife*this.starLifeVariation});this.glitter&&l&&(T.sparkFreq=l,T.sparkSpeed=h,T.sparkLife=c,T.sparkLifeVariation=m,T.sparkColor=this.glitterColor,T.sparkTimer=Math.random()*T.sparkFreq)})}else this.heart?pe(this.starCount,(g,L)=>{const f=Math.atan2(L,g),y=Math.sqrt(g*g+L*L);u(f,y)}):this.starShape?me(this.starCount,(g,L)=>{const f=Math.atan2(L,g),y=Math.sqrt(g*g+L*L);u(f,y)}):z(this.starCount,u);else if(Array.isArray(this.color))if(Math.random()<.5){const g=Math.random()*Math.PI;o=this.color[0],z(this.starCount,u,g,Math.PI),o=this.color[1],z(this.starCount,u,g+Math.PI,Math.PI)}else o=this.color[0],z(this.starCount/2,u),o=this.color[1],z(this.starCount/2,u);if(!this.disableWord&&d.get("wordShell")&&Math.random()<.1&&Math.random()<.5&&ge(Se(),(g,L)=>{C.addSpark({x:g.x,y:g.y,color:L,angle:Math.random()*E,speed:Math.pow(Math.random(),.15)*1.4,life:this.starLife+Math.random()*this.starLife*this.starLifeVariation+1e3})},e,t),this.pistil){const g=new b({shellSize:this.shellSize,spreadSize:this.spreadSize*.5,starLife:this.starLife*.6,starLifeVariation:this.starLifeVariation,starDensity:1.4,color:this.pistilColor,glitter:"light",disableWord:!0,glitterColor:this.pistilColor===p.Gold?p.Gold:p.White});g.setStage(this.stageW,this.stageH),g.burst(e,t)}if(this.streamers){const g=new b({shellSize:this.shellSize,spreadSize:this.spreadSize*.9,starLife:this.starLife*.8,starLifeVariation:this.starLifeVariation,starCount:Math.floor(Math.max(6,this.spreadSize/45)),color:p.White,disableWord:!0,glitter:"streamer"});g.setStage(this.stageW,this.stageH),g.burst(e,t)}if(C.addFlash(e,t,this.spreadSize/4),this.comet){const g=d.get("size"),L=2,y=(1-Math.min(L,g-this.shellSize)/L)*.3+.7;A("burst",y)}}}class Ke{stageW=0;stageH=0;currentFrame=0;autoLaunchTime=0;isFirstSeq=!0;finaleCount=32;currentFinaleCount=0;seqSmallBarrageCooldown=15e3;seqSmallBarrageLastCalled=Date.now();audioCallback=()=>{};constructor(){Ue({createBurst:this.createBurst.bind(this),createParticleArc:this.createParticleArc.bind(this),createWordBurst:this.createWordBurst.bind(this),createHeartBurst:this.createHeartBurst.bind(this),createStarBurst:this.createStarBurst.bind(this),randomWord:this.randomWord.bind(this)}),Qe({crossette:this.crossetteEffect.bind(this),floral:this.floralEffect.bind(this),fallingLeaves:this.fallingLeavesEffect.bind(this),crackle:this.crackleEffect.bind(this)})}setAudioCallback(e){this.audioCallback=e,$e(e)}setStage(e,t){this.stageW=e,this.stageH=t}update(e,t){this.currentFrame++,d.get("autoLaunch")&&(this.autoLaunchTime-=e,this.autoLaunchTime<=0&&(this.autoLaunchTime=this.startSequence()*1.25)),C.update(e,t,ve,this.currentFrame)}getRandomShellSize(){const e=d.get("size"),t=Math.min(2.5,e),s=Math.random()*t,i=e-s,a=t===0?Math.random():1-s/t,o=Math.random()*(1-a*.65)*.5,n=Math.random()<.5?.5-o:.5+o;return{size:i,x:this.fitShellPositionH(n),height:this.fitShellPositionV(a)}}fitShellPositionH(e){return(1-.18*2)*e+.18}fitShellPositionV(e){return e*.75}launchShellFromClick(e,t,s,i){const a=d.get("size"),o=new b(M.getConfiguredOptions(a));o.setStage(this.stageW,this.stageH),o.launch(e/s,1-t/i)}launchShell(e,t,s){const i=new b(M.getConfiguredOptions(s));i.setStage(this.stageW,this.stageH),i.launch(e,t)}startSequence(){if(this.isFirstSeq){if(this.isFirstSeq=!1,W)return this.seqTwoRandom();{const t=new b(M.createOptions("Crysanthemum",d.get("size")));return t.setStage(this.stageW,this.stageH),t.launch(.5,.5),2400}}if(d.get("finale"))return this.seqRandomFastShell(),this.currentFinaleCount<this.finaleCount?(this.currentFinaleCount++,170):(this.currentFinaleCount=0,6e3);const e=Math.random();return e<.08&&Date.now()-this.seqSmallBarrageLastCalled>this.seqSmallBarrageCooldown?this.seqSmallBarrage():e<.1?this.seqPyramid():e<.6&&!W?this.seqRandomShell():e<.8?this.seqTwoRandom():this.seqTriple()}seqRandomShell(){const e=this.getRandomShellSize(),t=new b(M.getConfiguredOptions(e.size));t.setStage(this.stageW,this.stageH),t.launch(e.x,e.height);let s=t.starLife;return t.fallingLeaves&&(s=4600),900+Math.random()*600+s}seqRandomFastShell(){const e=this.getRandomShellSize(),t=new b(M.getFastFactory()(e.size));return t.setStage(this.stageW,this.stageH),t.launch(e.x,e.height),900+Math.random()*600+t.starLife}seqTwoRandom(){const e=this.getRandomShellSize(),t=this.getRandomShellSize(),s=new b(M.getConfiguredOptions(e.size)),i=new b(M.getConfiguredOptions(t.size));s.setStage(this.stageW,this.stageH),i.setStage(this.stageW,this.stageH);const a=Math.random()*.2-.1,o=Math.random()*.2-.1;s.launch(.3+a,e.height),setTimeout(()=>i.launch(.7+o,t.height),100);let n=Math.max(s.starLife,i.starLife);return(s.fallingLeaves||i.fallingLeaves)&&(n=4600),900+Math.random()*600+n}seqTriple(){const e=M.getFastFactory(),t=d.get("size"),s=Math.max(0,t-1.25),i=new b(e(t));return i.setStage(this.stageW,this.stageH),i.launch(.5+Math.random()*.08-.04,.7),setTimeout(()=>{const a=new b(e(s));a.setStage(this.stageW,this.stageH),a.launch(.2+Math.random()*.08-.04,.1)},1e3+Math.random()*400),setTimeout(()=>{const a=new b(e(s));a.setStage(this.stageW,this.stageH),a.launch(.8+Math.random()*.08-.04,.1)},1e3+Math.random()*400),4e3}seqPyramid(){const e=_?7:4,t=d.get("size"),s=Math.max(0,t-3);let i=0,a=0;for(;i<=e;){const o=i,n=a;if(o===e)setTimeout(()=>{const l=new b(M.getConfiguredOptions(t));l.setStage(this.stageW,this.stageH),l.launch(.5,.75)},n);else{const l=o/e*.5;setTimeout(()=>{const h=new b(M.getConfiguredOptions(s));h.setStage(this.stageW,this.stageH);const c=l<=.5?l/.5:(1-l)/.5;h.launch(l,c*.42)},n),setTimeout(()=>{const h=new b(M.getConfiguredOptions(s));h.setStage(this.stageW,this.stageH);const c=1-l<=.5?(1-l)/.5:l/.5;h.launch(1-l,c*.42)},n+Math.random()*30+30)}i++,a+=200}return 3400+e*250}seqSmallBarrage(){this.seqSmallBarrageLastCalled=Date.now();const e=_?11:5,t=Math.max(0,d.get("size")-2);let s=0,i=0;for(;s<e;){const a=i;if(s===0){const o=new b(M.getConfiguredOptions(t));o.setStage(this.stageW,this.stageH),o.launch(.5,(Math.cos(.5*5*Math.PI+I)+1)/2*.75),s+=1}else{const o=(s+1)/e/2;setTimeout(()=>{const n=new b(M.getConfiguredOptions(t));n.setStage(this.stageW,this.stageH);const l=(Math.cos((.5+o)*5*Math.PI+I)+1)/2;n.launch(.5+o,l*.75)},a),setTimeout(()=>{const n=new b(M.getConfiguredOptions(t));n.setStage(this.stageW,this.stageH);const l=(Math.cos((.5-o)*5*Math.PI+I)+1)/2;n.launch(.5-o,l*.75)},a+Math.random()*30+30),s+=2}i+=200}return 3400+e*120}createParticleArc(e,t,s,i,a){const o=t/s,n=e+t-o*.5;if(n>e)for(let l=e;l<n;l+=o)a(l+Math.random()*o*i);else for(let l=e;l>n;l+=o)a(l+Math.random()*o*i)}createBurst(e,t,s=0,i=E){const o=2*(.5*Math.sqrt(e/Math.PI))*Math.PI,n=o/2;for(let l=0;l<=n;l++){const h=l/n*I,c=Math.cos(h),m=o*c,S=m*(i/E),u=E/m,g=Math.random()*u+s,L=u*.33;for(let f=0;f<S;f++){const y=Math.random()*L,D=u*f+g+y;t(D,c)}}}createWordBurst(e,t,s,i){const a=Math.floor(Math.random()*70+60),o=x.literalLattice(e,3,"Gabriola,åŽæ–‡ç¥ç€",a+"px");if(!o)return;const n=o.width/2,l=o.height/2,h=k(),c=Math.random()<.5,m=c?k():h;for(let S=0;S<o.points.length;S++){const u=o.points[S];t({x:s+(u.x-n),y:i+(u.y-l)},h,c,m)}}randomWord(){const e=["Glow","Spark","Fire","Light","Star","Burst","Pop","Boom","2025","Wow","Cool","Yay","Fun","Love","Happy","Dream"];return e[Math.floor(Math.random()*e.length)]}createHeartBurst(e,t){const s=Math.floor(e/14)||1;for(let i=0;i<s;i++){const a=.25+i/s*.75,o=Math.floor(a*e/s*2.5)+10,n=E/o;for(let l=0;l<o;l++){const h=l*n,c=a*.06,m=16*Math.pow(Math.sin(h),3)*c,S=-(13*Math.cos(h)-5*Math.cos(2*h)-2*Math.cos(3*h)-Math.cos(4*h))*c;t(m,S)}}}createStarBurst(e,t){const i=Math.floor(e/14)||1,a=.5;for(let o=0;o<i;o++){const n=.3+o/i*.7,l=Math.floor(n*e/i*3)+10;for(let h=0;h<l;h++){const c=h/l*E,m=E/5,S=c%m/m;let u=1;if(S<.5){const f=S*2;u=(1-f)*1+f*a}else{const f=(S-.5)*2;u=(1-f)*a+f*1}const g=Math.sin(c)*u*n,L=-Math.cos(c)*u*n;t(g,L)}}}crossetteEffect(e){const t=Math.random()*I;this.createParticleArc(t,E,4,.5,s=>{C.addStar({x:e.x,y:e.y,color:e.color,angle:s,speed:Math.random()*.6+.75,life:600})})}floralEffect(e){const s=12+6*d.quality;this.createBurst(s,(i,a)=>{C.addStar({x:e.x,y:e.y,color:e.color,angle:i,speed:a*2.4,life:1e3+Math.random()*300,speedOffX:e.speedX,speedOffY:e.speedY})}),C.addFlash(e.x,e.y,46),this.audioCallback("burstSmall")}fallingLeavesEffect(e){this.createBurst(7,(t,s)=>{const i=C.addStar({x:e.x,y:e.y,color:H,angle:t,speed:s*2.4,life:2400+Math.random()*600,speedOffX:e.speedX,speedOffY:e.speedY});i.sparkColor=p.Gold,i.sparkFreq=144/d.quality,i.sparkSpeed=.28,i.sparkLife=750,i.sparkLifeVariation=3.2}),C.addFlash(e.x,e.y,46),this.audioCallback("burstSmall")}crackleEffect(e){const t=d.isHighQuality?32:16;this.createParticleArc(0,E,t,1.8,s=>{C.addSpark({x:e.x,y:e.y,color:p.Gold,angle:s,speed:Math.pow(Math.random(),.45)*2.4,life:300+Math.random()*200})})}}const N=new Ke;class je{baseURL="./audio/";ctx=null;sources={lift:{volume:1,playbackRateMin:.85,playbackRateMax:.95,fileNames:["lift1.mp3","lift2.mp3","lift3.mp3"]},burst:{volume:1,playbackRateMin:.8,playbackRateMax:.9,fileNames:["burst1.mp3","burst2.mp3"]},burstSmall:{volume:.25,playbackRateMin:.8,playbackRateMax:1,fileNames:["burst-sm-1.mp3","burst-sm-2.mp3"]},crackle:{volume:.2,playbackRateMin:1,playbackRateMax:1,fileNames:["crackle1.mp3"]},crackleSmall:{volume:.3,playbackRateMin:1,playbackRateMax:1,fileNames:["crackle-sm-1.mp3"]}};lastSmallBurstTime=0;simSpeed=1;constructor(){d.subscribe((e,t)=>{const s=e.soundEnabled&&!e.paused,i=t.soundEnabled&&!t.paused;s!==i&&(s?this.resume():this.pause())})}initContext(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))}setSimSpeed(e){this.simSpeed=e}async preload(){if(this.initContext(),!this.ctx)return;const e=[],t=s=>{if(s.status>=200&&s.status<300)return s;throw new Error(s.statusText)};for(const s of Object.keys(this.sources)){const i=this.sources[s],a=[];for(const o of i.fileNames){const n=this.baseURL+o,l=fetch(n).then(t).then(h=>h.arrayBuffer()).then(h=>new Promise(c=>{this.ctx.decodeAudioData(h,c)}));a.push(l),e.push(l)}Promise.all(a).then(o=>{i.buffers=o})}await Promise.all(e)}pause(){this.ctx?.suspend()}resume(){if(!this.ctx)return;const e=this.sources.lift;if(e?.buffers){const t=this.ctx.createGain();t.gain.value=0;const s=e.buffers[0],i=this.ctx.createBufferSource();i.buffer=s,i.connect(t),t.connect(this.ctx.destination),i.start(0)}setTimeout(()=>{this.ctx?.resume()},250)}play(e,t=1){if(!this.ctx||(t=x.clamp(t,0,1),!d.canPlaySound||this.simSpeed<.95))return;if(e==="burstSmall"){const m=Date.now();if(m-this.lastSmallBurstTime<20)return;this.lastSmallBurstTime=m}const s=this.sources[e];if(!s||!s.buffers)return;const i=s.volume,a=x.random(s.playbackRateMin,s.playbackRateMax),o=i*t,n=a*(2-t),l=this.ctx.createGain();l.gain.value=o;const h=x.randomChoice(s.buffers),c=this.ctx.createBufferSource();c.playbackRate.value=n,c.buffer=h,c.connect(l),l.connect(this.ctx.destination),c.start(0)}}const X=new je;class Je{trailsStage;mainStage;stageW=0;stageH=0;speedBarOpacity=0;simSpeed=1;currentSkyColor={r:0,g:0,b:0};targetSkyColor={r:0,g:0,b:0};canvasContainer=null;constructor(e,t){this.trailsStage=e,this.mainStage=t,this.canvasContainer=document.querySelector(".canvas-container")}setDimensions(e,t){this.stageW=e,this.stageH=t}setSimSpeed(e){this.simSpeed=e}setSpeedBarOpacity(e){this.speedBarOpacity=e}fadeSpeedBar(e){!d.get("menuOpen")&&this.speedBarOpacity!==0&&(this.speedBarOpacity-=e/30,this.speedBarOpacity<0&&(this.speedBarOpacity=0))}resize(e,t){this.trailsStage.resize(e,t),this.mainStage.resize(e,t)}render(e){const{dpr:t}=this.mainStage,s=this.trailsStage.ctx,i=this.mainStage.ctx,a=d.isLowQuality,o=d.get("scaleFactor");d.get("skyLighting")!==re&&this.colorSky(e),s.scale(t*o,t*o),i.scale(t*o,t*o),s.globalCompositeOperation="source-over";const n=d.get("longExposure")?.0025:.175*e;s.fillStyle=`rgba(0, 0, 0, ${n})`,s.fillRect(0,0,this.stageW,this.stageH),i.clearRect(0,0,this.stageW,this.stageH),this.renderFlashes(s),s.globalCompositeOperation="lighten",this.renderStars(s,i,a),this.renderSparks(s),this.speedBarOpacity>0&&(i.globalAlpha=this.speedBarOpacity,i.fillStyle=p.Blue,i.fillRect(0,this.stageH-6,this.stageW*this.simSpeed,6),i.globalAlpha=1),s.setTransform(1,0,0,1,0,0),i.setTransform(1,0,0,1,0,0)}renderFlashes(e){for(;C.activeFlashes.length>0;){const t=C.popFlash();if(!t)break;const s=t.x,i=t.y,a=t.radius,o=e.createRadialGradient(s,i,0,s,i,a);o.addColorStop(.024,"rgba(255, 255, 255, 1)"),o.addColorStop(.125,"rgba(255, 160, 20, 0.2)"),o.addColorStop(.32,"rgba(255, 140, 20, 0.11)"),o.addColorStop(1,"rgba(255, 120, 20, 0)"),e.fillStyle=o,e.fillRect(s-a,i-a,a*2,a*2)}}renderStars(e,t,s){e.lineWidth=3,e.lineCap=s?"square":"round",t.strokeStyle="#fff",t.lineWidth=1,t.beginPath(),O.forEach(i=>{const a=C.activeStars[i];e.strokeStyle=i,e.beginPath(),a.forEach(o=>{o.visible&&(e.lineWidth=o.size,e.moveTo(o.x,o.y),e.lineTo(o.prevX,o.prevY),t.moveTo(o.x,o.y),t.lineTo(o.x-o.speedX*1.6,o.y-o.speedY*1.6))}),e.stroke()}),t.stroke()}renderSparks(e){e.lineWidth=C.sparkDrawWidth,e.lineCap="butt",O.forEach(t=>{const s=C.activeSparks[t];e.strokeStyle=t,e.beginPath(),s.forEach(i=>{e.moveTo(i.x,i.y),e.lineTo(i.prevX,i.prevY)}),e.stroke()})}colorSky(e){const s=d.get("skyLighting")*15,i=500,a=C.getTotalStarCount(),o=C.getColorBrightness(),n=Math.pow(Math.min(1,a/i),.3),l=Math.max(1,o.r,o.g,o.b);this.targetSkyColor.r=o.r/l*s*n,this.targetSkyColor.g=o.g/l*s*n,this.targetSkyColor.b=o.b/l*s*n;const h=10;this.currentSkyColor.r+=(this.targetSkyColor.r-this.currentSkyColor.r)/h*e,this.currentSkyColor.g+=(this.targetSkyColor.g-this.currentSkyColor.g)/h*e,this.currentSkyColor.b+=(this.targetSkyColor.b-this.currentSkyColor.b)/h*e,this.canvasContainer&&(this.canvasContainer.style.backgroundColor=`rgb(${this.currentSkyColor.r|0}, ${this.currentSkyColor.g|0}, ${this.currentSkyColor.b|0})`)}}class Ze{stage;stageContainer;handlers=null;activePointerCount=0;isUpdatingSpeed=!1;simSpeed=1;stageW=0;stageH=0;constructor(e){this.stage=e,this.stageContainer=document.querySelector(".stage-container"),this.stage.addEventListener("pointerstart",this.handlePointerStart.bind(this)),this.stage.addEventListener("pointerend",this.handlePointerEnd.bind(this)),this.stage.addEventListener("pointermove",this.handlePointerMove.bind(this)),window.addEventListener("keydown",this.handleKeydown.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}setHandlers(e){this.handlers=e}setSimSpeed(e){this.simSpeed=e}getSimSpeed(){return this.simSpeed}getDimensions(){return{width:this.stage.width,height:this.stage.height,stageW:this.stageW,stageH:this.stageH}}handleResize(){const e=window.innerWidth,t=window.innerHeight,s=Math.min(e,we),i=e<=420?t:Math.min(t,Me);this.stageContainer&&(this.stageContainer.style.width=s+"px",this.stageContainer.style.height=i+"px");const a=d.get("scaleFactor");return this.stageW=s/a,this.stageH=i/a,{containerW:s,containerH:i,stageW:this.stageW,stageH:this.stageH}}handlePointerStart(e){this.activePointerCount++;const t=50;if(e.y<t){if(e.x<t){this.handlers?.onPauseToggle();return}if(e.x>this.stage.width/2-t/2&&e.x<this.stage.width/2+t/2){this.handlers?.onSoundToggle();return}if(e.x>this.stage.width-t){this.handlers?.onMenuToggle();return}}d.isRunning&&(this.updateSpeedFromEvent(e)?this.isUpdatingSpeed=!0:e.onCanvas&&this.handlers?.onShellLaunch(e.x,e.y))}handlePointerEnd(e){this.activePointerCount--,this.isUpdatingSpeed=!1}handlePointerMove(e){d.isRunning&&this.isUpdatingSpeed&&this.updateSpeedFromEvent(e)}handleKeydown(e){e.keyCode===80?this.handlers?.onPauseToggle():e.keyCode===79?this.handlers?.onMenuToggle():e.keyCode===27&&d.toggleMenu(!1)}updateSpeedFromEvent(e){if(this.isUpdatingSpeed||e.y>=this.stage.height-44){const s=(e.x-16)/(this.stage.width-32);return this.simSpeed=Math.min(Math.max(s,0),1),this.handlers?.onSpeedChange(this.simSpeed),!0}return!1}}const q={fullscreenEnabled:0,fullscreenElement:1,requestFullscreen:2,exitFullscreen:3,fullscreenchange:4,fullscreenerror:5},Z=["webkitFullscreenEnabled","webkitFullscreenElement","webkitRequestFullscreen","webkitExitFullscreen","webkitfullscreenchange","webkitfullscreenerror"],ee=["mozFullScreenEnabled","mozFullScreenElement","mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozfullscreenerror"],te=["msFullscreenEnabled","msFullscreenElement","msRequestFullscreen","msExitFullscreen","MSFullscreenChange","MSFullscreenError"],v=typeof window<"u"&&typeof window.document<"u"?window.document:{},F="fullscreenEnabled"in v&&Object.keys(q)||Z[0]in v&&Z||ee[0]in v&&ee||te[0]in v&&te||[],B={requestFullscreen(r){return r[F[q.requestFullscreen]]()},requestFullscreenFunction(r){return r[F[q.requestFullscreen]]},get exitFullscreen(){return v[F[q.exitFullscreen]].bind(v)},addEventListener(r,e,t){v.addEventListener(F[q[r]],e,t)},removeEventListener(r,e){v.removeEventListener(F[q[r]],e)},get fullscreenEnabled(){return!!v[F[q.fullscreenEnabled]]},set fullscreenEnabled(r){},get fullscreenElement(){return v[F[q.fullscreenElement]]},set fullscreenElement(r){},get onfullscreenchange(){return v[("on"+F[q.fullscreenchange]).toLowerCase()]},set onfullscreenchange(r){v[("on"+F[q.fullscreenchange]).toLowerCase()]=r},get onfullscreenerror(){return v[("on"+F[q.fullscreenerror]).toLowerCase()]},set onfullscreenerror(r){v[("on"+F[q.fullscreenerror]).toLowerCase()]=r}};window.fscreen=B;const se={shellType:{header:"Shell Type",body:'The type of firework shell to launch. "Random" will select a different type for each shell.'},shellSize:{header:"Shell Size",body:"The size of the firework shells. Larger shells have bigger and longer-lasting bursts."},quality:{header:"Quality",body:"Overall quality of the effects. Lower quality uses fewer particles and simpler effects, improving performance on slower devices."},skyLighting:{header:"Sky Lighting",body:'How much the sky lights up with the color of fireworks. Set to "None" for a pure black sky.'},scaleFactor:{header:"Scale",body:"Makes the simulation area smaller, improving performance. Use this if the animation is running slowly."},autoLaunch:{header:"Auto Fire",body:"Automatically launches fireworks. Disable for a more relaxed experience where you control the show."},finaleMode:{header:"Finale Mode",body:"Rapidly launches many shells for a grand finale effect."},hideControls:{header:"Hide Controls",body:"Hides the control buttons at the top of the screen for a cleaner view."},fullscreen:{header:"Fullscreen",body:"Expands the simulation to fill your entire screen."},longExposure:{header:"Long Exposure",body:'Simulates a long camera exposure, creating light trails and a "painting with light" effect.'}},ie={shellTypeLabel:"shellType",shellSizeLabel:"shellSize",qualityLabel:"quality",skyLightingLabel:"skyLighting",scaleFactorLabel:"scaleFactor",autoLaunchLabel:"autoLaunch",finaleModeLabel:"finaleMode",hideControlsLabel:"hideControls",fullscreenLabel:"fullscreen",longExposureLabel:"longExposure"};class et{nodes={};constructor(){this.initNodes(),this.setupEventListeners(),this.setupConfigSubscription(),this.populateDropdowns()}initNodes(){this.nodes={stageContainer:document.querySelector(".stage-container"),canvasContainer:document.querySelector(".canvas-container"),controls:document.querySelector(".controls"),menu:document.querySelector(".menu"),pauseBtn:document.querySelector(".pause-btn"),pauseBtnSVG:document.querySelector(".pause-btn use"),soundBtn:document.querySelector(".sound-btn"),soundBtnSVG:document.querySelector(".sound-btn use"),menuBtn:document.querySelector(".menu-btn"),shellType:document.querySelector(".shell-type"),shellSize:document.querySelector(".shell-size"),quality:document.querySelector(".quality-ui"),skyLighting:document.querySelector(".sky-lighting"),scaleFactor:document.querySelector(".scaleFactor"),autoLaunch:document.querySelector(".auto-launch"),finaleMode:document.querySelector(".finale-mode"),hideControls:document.querySelector(".hide-controls"),fullscreen:document.querySelector(".fullscreen"),longExposure:document.querySelector(".long-exposure"),wordShell:document.querySelector(".word-shell"),fullscreenFormOption:document.querySelector(".fullscreen-form-option"),finaleModeFormOption:document.querySelector(".finale-mode-form-option"),helpModal:document.querySelector(".help-modal"),helpModalOverlay:document.querySelector(".help-modal__overlay"),helpModalHeader:document.querySelector(".help-modal__header"),helpModalBody:document.querySelector(".help-modal__body"),helpModalCloseBtn:document.querySelector(".help-modal__close-btn"),shellTypeLabel:document.querySelector('label[for="shell-type"]'),shellSizeLabel:document.querySelector('label[for="shell-size"]'),qualityLabel:document.querySelector('label[for="quality"]'),skyLightingLabel:document.querySelector('label[for="sky-lighting"]'),scaleFactorLabel:document.querySelector('label[for="scale-factor"]'),autoLaunchLabel:document.querySelector('label[for="auto-launch"]'),finaleModeLabel:document.querySelector('label[for="finale-mode"]'),hideControlsLabel:document.querySelector('label[for="hide-controls"]'),fullscreenLabel:document.querySelector('label[for="fullscreen"]'),longExposureLabel:document.querySelector('label[for="long-exposure"]')}}getNode(e){return this.nodes[e]||null}setupEventListeners(){this.addInputListener("shellType","shell"),this.addInputListener("shellSize","size",parseInt),this.addInputListener("quality","quality",parseInt),this.addInputListener("skyLighting","skyLighting",parseInt),this.addInputListener("scaleFactor","scaleFactor",parseFloat),this.addCheckboxListener("autoLaunch","autoLaunch"),this.addCheckboxListener("finaleMode","finale"),this.addCheckboxListener("hideControls","hideControls"),this.addCheckboxListener("longExposure","longExposure"),this.addCheckboxListener("wordShell","wordShell"),this.nodes.fullscreen?.addEventListener("click",()=>{this.toggleFullscreen()}),Object.keys(ie).forEach(e=>{const t=ie[e];this.nodes[e]?.addEventListener("click",()=>{d.setHelpTopic(t)})}),this.nodes.helpModalCloseBtn?.addEventListener("click",()=>{d.setHelpTopic(null)}),this.nodes.helpModalOverlay?.addEventListener("click",()=>{d.setHelpTopic(null)}),this.nodes.scaleFactor?.addEventListener("input",()=>{window.dispatchEvent(new Event("resize"))})}addInputListener(e,t,s){const i=this.nodes[e];i?.addEventListener("input",()=>{const a=s?s(i.value):i.value;d.set(t,a)})}addCheckboxListener(e,t){const s=this.nodes[e];s?.addEventListener("click",()=>{setTimeout(()=>{d.set(t,s.checked)},0)})}setupConfigSubscription(){d.subscribe((e,t)=>{this.render(e)})}populateDropdowns(){const e=this.nodes.shellType;if(e){let o="";M.getTypeNames().forEach(n=>{o+=`<option value="${n}">${n}</option>`}),e.innerHTML=o}const t=this.nodes.shellSize;if(t){let o="";['3"','4"','6"','8"','12"','16"'].forEach((n,l)=>{o+=`<option value="${l}">${n}</option>`}),t.innerHTML=o}const s=this.nodes.quality;s&&(s.innerHTML=`
        <option value="${Q}">Low</option>
        <option value="${Y}">Normal</option>
        <option value="${P}">High</option>
      `);const i=this.nodes.skyLighting;i&&(i.innerHTML=`
        <option value="${re}">None</option>
        <option value="${be}">Dim</option>
        <option value="${oe}">Normal</option>
      `);const a=this.nodes.scaleFactor;if(a){let o="";[.5,.62,.75,.9,1,1.5,2].forEach(n=>{o+=`<option value="${n.toFixed(2)}">${n*100}%</option>`}),a.innerHTML=o}}render(e){const{paused:t,soundEnabled:s,menuOpen:i,openHelpTopic:a,fullscreen:o,...n}=e,l=this.nodes.pauseBtnSVG;l&&(l.setAttribute("href",`#icon-${t?"play":"pause"}`),l.setAttribute("xlink:href",`#icon-${t?"play":"pause"}`));const h=this.nodes.soundBtnSVG;if(h&&(h.setAttribute("href",`#icon-sound-${s?"on":"off"}`),h.setAttribute("xlink:href",`#icon-sound-${s?"on":"off"}`)),this.nodes.controls?.classList.toggle("hide",n.hideControls),this.nodes.menu?.classList.toggle("hide",!i),this.nodes.menu?.classList.toggle("hide",!i),this.nodes.canvasContainer?.classList.toggle("blur",i),this.nodes.controls?.classList.toggle("blur",i),this.setSelectValue("shellType",n.shell),this.setSelectValue("shellSize",n.size),this.setSelectValue("quality",n.quality),this.setSelectValue("skyLighting",n.skyLighting),this.setSelectValue("scaleFactor",n.scaleFactor?.toFixed(2)),this.setCheckboxValue("autoLaunch",n.autoLaunch),this.setCheckboxValue("finaleMode",n.finale),this.setCheckboxValue("hideControls",n.hideControls),this.setCheckboxValue("fullscreen",o),this.setCheckboxValue("longExposure",n.longExposure),this.setCheckboxValue("wordShell",n.wordShell),this.nodes.finaleModeFormOption&&(this.nodes.finaleModeFormOption.style.display=n.autoLaunch?"":"none"),a&&se[a]){const c=se[a];this.nodes.helpModalHeader&&(this.nodes.helpModalHeader.textContent=c.header),this.nodes.helpModalBody&&(this.nodes.helpModalBody.textContent=c.body)}this.nodes.helpModal?.classList.toggle("active",!!a),document.body.classList.toggle("menu-open",i)}setSelectValue(e,t){const s=this.nodes[e];s&&t!==void 0&&(s.value=String(t))}setCheckboxValue(e,t){const s=this.nodes[e];s&&t!==void 0&&(s.checked=t)}toggleFullscreen(){B.fullscreenElement?(B.exitFullscreen(),d.toggleFullscreen(!1)):this.nodes.stageContainer&&(B.requestFullscreen(this.nodes.stageContainer),d.toggleFullscreen(!0))}isFullscreenEnabled(){return B.fullscreenEnabled}removeLoadingState(){document.querySelector(".loading-init")?.remove(),this.nodes.stageContainer?.classList.remove("remove")}setLoadingStatus(e){const t=document.querySelector(".loading-init__status");t&&(t.textContent=e)}}const $=new et;class tt{trailsStage;mainStage;renderer;inputManager;simSpeed=1;constructor(){d.load(),this.trailsStage=new w("trails-canvas"),this.mainStage=new w("main-canvas"),this.renderer=new Je(this.trailsStage,this.mainStage),this.inputManager=new Ze(this.mainStage),this.inputManager.setHandlers({onShellLaunch:(e,t)=>{N.launchShellFromClick(e,t,this.mainStage.width,this.mainStage.height)},onSpeedChange:e=>{this.simSpeed=e,this.renderer.setSimSpeed(e),this.renderer.setSpeedBarOpacity(1),X.setSimSpeed(e)},onPauseToggle:()=>d.togglePause(),onSoundToggle:()=>d.toggleSound(),onMenuToggle:()=>d.toggleMenu()}),N.setAudioCallback((e,t)=>{X.play(e,t)}),this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}handleResize(){const e=this.inputManager.handleResize();this.renderer.resize(e.containerW,e.containerH),this.renderer.setDimensions(e.stageW,e.stageH),N.setStage(e.stageW,e.stageH),this.trailsStage.resize(e.containerW,e.containerH),this.mainStage.resize(e.containerW,e.containerH)}update=(e,t)=>{if(!d.isRunning)return;const s=e*this.simSpeed,i=this.simSpeed*t;this.renderer.fadeSpeedBar(t),N.update(s,i),this.renderer.render(i)};async start(){$.removeLoadingState(),$.render(d.getState()),d.togglePause(!1),this.mainStage.addEventListener("ticker",this.update),console.log("ðŸŽ† Firework Simulator loaded with class-based architecture!")}async init(){if(W)await this.start();else{$.setLoadingStatus("Lighting the fuse...");try{await X.preload()}catch(e){console.warn("Failed to preload audio:",e)}await this.start()}}}const st=new tt;st.init();
